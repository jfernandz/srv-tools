= backup tools

Small set of generic backup scripts for systemd services.

- `backup-units-generator.sh`: reads YAML/JSON config and generates:
  - `backup@<escaped-service>.timer`
  - `backup@specific_targets.timer` when top-level `specific_targets:` is defined
  - per-service runtime config file (`<service>.conf`)
- `backup.sh`: runtime executor used by `backup@.service`.
- `backup-fetcher.sh`: retrieves backups from a remote host through SSH using `rsync`.

Template unit provided by this project:

- `backup@.service` (installed as `/usr/lib/systemd/system/backup@.service` in package builds)

== Requirements (backup-tools)

- `bash`
- `systemd`
- `7z`
- `yq` (mikefarah/yq)

== Requirements (backup-fetcher)

- `bash`
- `systemd` (only for `--install`/`--install-timer`)
- `rsync`
- `openssh`

== Backup Fetcher

Use `backup-fetcher.sh` to pull backup files from a remote server:

----
./backup-fetcher.sh \
  --user backup \
  --host backup.example.com \
  --source /srv/backups/ \
  --destination /srv/restore/backups
----

Available options include `--port`, `--identity-file`, `--delete`, `--dry-run`,
and `--max-retention-days`.
You can also configure it with environment variables:
`FETCH_USER`, `FETCH_HOST`, `FETCH_SOURCE`, `FETCH_DESTINATION`,
`FETCH_PORT`, `FETCH_IDENTITY_FILE`, `FETCH_DELETE`, `FETCH_DRY_RUN`,
and `FETCH_MAX_RETENTION_DAYS`.
CLI options override environment values.

Install systemd units directly from the script:

----
sudo backup-fetcher.sh \
  --install-timer \
  --on-calendar "*-*-* 01:30:00"
----

This generates:

- `/etc/systemd/system/backup-fetcher.service`
- `/etc/systemd/system/backup-fetcher.timer`
- `/etc/backup-tools/backup-fetcher.env` (template, only if missing)

The generated service uses:

- `ExecStart=/usr/local/bin/backup-fetcher.sh` by default
- `EnvironmentFile=-/etc/backup-tools/backup-fetcher.env`

Then enable the timer:

----
sudo systemctl daemon-reload
sudo systemctl enable --now backup-fetcher.timer
----

== Quick Start

1. Copy and edit the example config:
+
----
cp backup-config.example.yaml /etc/backup-tools/config.yaml
----
+
Ensure `backup@.service` is installed (package installs it under `/usr/lib/systemd/system`; for local source testing you can place it in `/etc/systemd/system`).
+
2. Generate unit files and runtime configs:
+
----
./backup-units-generator.sh \
  --config /etc/backup-tools/config.yaml \
  --units-dir /etc/systemd/system \
  --service-config-dir /etc/backup-tools
----

If `--config` is omitted, default path `/etc/backup-tools/config.yaml` is used.
+
3. Reload systemd and enable timers:
+
----
systemctl daemon-reload
systemctl enable --now backup@<escaped-service>.timer
----

== Config Format

You can define global fallback keys at top-level and per-service overrides.

Top-level fallback keys:

- `output_dir`
- `compression_lvl`
- `retention_days`
- `on_calendar`
- `randomized_delay`
- `persistent`
- `owner`
- `stop_wait_seconds`
- `restart_after_backup`
- `path_mode` (`target` | `preserve` | `contents`, default `target`)

Service definitions must be defined under the `services:` mapping.
Each key is the service name without the `.service` suffix.
`exclude_patterns` is only read from each service block.
Optional top-level `specific_targets:` creates a separate generic backup job.
`specific_targets:` can be either:

- a list of directories/files
- a mapping with `dirs` and optional overrides (`output_dir`, `compression_lvl`, `owner`, etc.)

Per-service keys:

- `dirs` (required): directories/files to archive
- `output_dir` (required unless provided globally)
- `exclude_patterns` (service-specific)
- `compression_lvl`
- `retention_days`
- `on_calendar`
- `randomized_delay`
- `persistent`
- `owner` (`user` or `user:group`)
- `stop_wait_seconds`
- `restart_after_backup`
- `path_mode` (`target` | `preserve` | `contents`)

Example:

----
# Global fallback values
output_dir: /srv/backups
compression_lvl: 3
retention_days: 14
on_calendar: "*-*-* 11:30:00"
randomized_delay: 15m
persistent: true
owner: wyre
path_mode: target

specific_targets:
  - /etc
  - /usr/local/bin
  - /home/wyre/somefolder/id/like/tobackup

services:
  mc@fabric_kmz:
    dirs:
      - /home/wyre/mcserver/Fabric/fabric_kmz
    output_dir: /home/wyre/mcserver/backups
    exclude_patterns:
      - 'dynmap/web/*'

  httpd:
    dirs:
      - /etc/httpd
      - /var/www
    output_dir: /srv/backups/httpd
    exclude_patterns:
      - '*.tmp'
    compression_lvl: 5
    retention_days: 21
    on_calendar: "*-*-* 03:15:00"
    randomized_delay: 5m
    persistent: true
    owner: root
    restart_after_backup: false
    path_mode: target
----

== What Gets Generated

For each service:

- Timer unit: `backup@<escaped-service>.timer`
  - Uses `OnCalendar`, `RandomizedDelaySec`, `Persistent`
  - Targets escaped template instance `backup@<escaped-service>.service`
- Runtime config: `<service-config-dir>/<service>.conf`
  - Shell variables consumed by `backup.sh`

For top-level `specific_targets:` (if present):

- Timer unit: `backup@specific_targets.timer`
  - Targets `backup@specific_targets.service`
- Runtime config: `<service-config-dir>/specific_targets.conf`

== Generated Files Example

Using the example config in `src/backup-config.example.yaml`, with:

- `--units-dir /etc/systemd/system`
- `--service-config-dir /etc/backup-tools`

the generator creates timer/config files that use `backup@.service`.

`/usr/lib/systemd/system/backup@.service` (installed by package):

----
[Unit]
Description=Run backup job for %I

[Service]
Type=oneshot
ExecStart=/usr/bin/backup.sh /etc/backup-tools/%I.conf
----

`/etc/systemd/system/backup@mc\x40fabric_kmz.timer`:

----
[Unit]
Description=Scheduled backup for mc@fabric_kmz.service

[Timer]
OnCalendar=*-*-* 11:30:00
Persistent=true
RandomizedDelaySec=15m
Unit=backup@mc\x40fabric_kmz.service

[Install]
WantedBy=timers.target
----

`/etc/backup-tools/mc@fabric_kmz.conf`:

----
SERVICE_NAME=mc@fabric_kmz.service
BACKUP_DIR=/home/wyre/mcserver/backups
BACKUP_LEVEL=3
BACKUP_RETENTION_DAYS=14
BACKUP_PREFIX=mc@fabric_kmz
BACKUP_OWNER=wyre
STOP_WAIT_SECONDS=300
RESTART_AFTER_BACKUP=true
PATH_MODE=target
BACKUP_DIRS=(
  /home/wyre/mcserver/Fabric/fabric_kmz
)
EXCLUDE_PATTERNS=(
  dynmap/web/*
)
----

`/etc/systemd/system/backup@httpd.timer`:

----
[Unit]
Description=Scheduled backup for httpd.service

[Timer]
OnCalendar=*-*-* 03:15:00
Persistent=true
RandomizedDelaySec=5m
Unit=backup@httpd.service

[Install]
WantedBy=timers.target
----

`/etc/backup-tools/httpd.conf`:

----
SERVICE_NAME=httpd.service
BACKUP_DIR=/srv/backups/httpd
BACKUP_LEVEL=5
BACKUP_RETENTION_DAYS=21
BACKUP_PREFIX=httpd
BACKUP_OWNER=root
STOP_WAIT_SECONDS=300
RESTART_AFTER_BACKUP=false
PATH_MODE=target
BACKUP_DIRS=(
  /etc/httpd
  /var/www
)
EXCLUDE_PATTERNS=(
  *.tmp
)
----

`/etc/systemd/system/backup@specific_targets.timer`:

----
[Unit]
Description=Scheduled backup for configured specific targets

[Timer]
OnCalendar=*-*-* 11:30:00
Persistent=true
RandomizedDelaySec=15m
Unit=backup@specific_targets.service

[Install]
WantedBy=timers.target
----

`/etc/backup-tools/specific_targets.conf`:

----
BACKUP_DIR=/srv/backups
BACKUP_LEVEL=3
BACKUP_RETENTION_DAYS=14
BACKUP_PREFIX=specific_targets
BACKUP_OWNER=wyre
STOP_WAIT_SECONDS=300
RESTART_AFTER_BACKUP=false
PATH_MODE=target
BACKUP_DIRS=(
  /etc
  /usr/local/bin
  /home/wyre/somefolder/id/like/tobackup
)
EXCLUDE_PATTERNS=()
----

== Runtime Behavior (`backup.sh`)

`backup.sh <config-file>` performs:

1. Load generated config file
2. If `SERVICE_NAME` is set: stop target systemd service
3. If `SERVICE_NAME` is set: wait for stop (up to `STOP_WAIT_SECONDS`)
4. Create archive with `7z` from `BACKUP_DIRS` + `EXCLUDE_PATTERNS`
   - `path_mode=target`: store each source under only its target folder name (default behavior)
   - `path_mode=preserve`: keep full source path context (for absolute paths, archive paths like `etc/httpd/...`)
   - `path_mode=contents`: store only each source folder contents (no top folder wrapper)
5. Delete old archives using `BACKUP_RETENTION_DAYS`
6. If `BACKUP_OWNER` is set: apply owner to archive file (`chown`)
7. If `SERVICE_NAME` is set: restart service if it was active and `RESTART_AFTER_BACKUP=true`

Archive naming:

- `<BACKUP_PREFIX>_<YYYY-MM-DD_HH-MM-SS>.7z`

== Manual Run (without timer)

After generation, run a backup directly:

----
systemctl start backup@<escaped-service>.service
systemctl start backup@specific_targets.service
----

Or run the runner manually:

----
./backup.sh /etc/backup-tools/<service>.conf
./backup.sh /etc/backup-tools/specific_targets.conf
----

== Notes

- If `exclude_patterns` is omitted, no exclude patterns are applied.
- Exclude entries should be plain patterns (for example `dynmap/web/*`); `backup.sh` adds `-xr!` automatically.
- If neither valid services nor a usable `specific_targets:` block are found, generation fails fast.
- If a service key does not map to an existing `<name>.service` unit, that service is skipped and no timer/config is generated for it.
