= backup-tools(7)
:doctype: manpage
:manmanual: backup-tools Manual
:mansource: backup-tools

== NAME

backup-tools - config-driven systemd backup unit generator and runner

== DESCRIPTION

backup-tools provides two scripts to schedule and run backups for systemd services:

- `backup-units-generator.sh`: reads YAML/JSON config and generates per-job timer units and runtime config files.
- `backup.sh`: oneshot backup runner used by `backup@.service`.

Template unit provided by this project:

- `backup@.service` (installed as `/usr/lib/systemd/system/backup@.service` in package builds)

The workflow is intentionally generic and service-agnostic.

== REQUIREMENTS

- bash
- systemd
- 7z
- yq (mikefarah/yq)

== CONFIGURATION

Input config must be YAML or JSON and define services under a `services:` block.
Service keys are service names *without* the `.service` suffix.
Optional top-level `paths:` defines a separate generic backup job.
`paths:` may be either a list of paths or a mapping with `dirs` and optional overrides (including `owner`).

Top-level fallback keys:

- `output_dir`
- `compression_lvl`
- `retention_days`
- `on_calendar`
- `randomized_delay`
- `persistent`
- `owner`
- `stop_wait_seconds`
- `restart_after_backup`
- `path_mode` (`target` | `preserve` | `contents`, default `target`)

Per-service keys:

- `dirs` (required)
- `output_dir` (required unless provided globally)
- `exclude_patterns` (optional, plain patterns)
- `compression_lvl`
- `retention_days`
- `on_calendar`
- `randomized_delay`
- `persistent`
- `owner` (`user` or `user:group`)
- `stop_wait_seconds`
- `restart_after_backup`
- `path_mode` (`target` | `preserve` | `contents`)

If `exclude_patterns` is omitted, no excludes are applied.

== COMMANDS

Generate units and runtime configs:

----
backup-units-generator.sh \
  --config /etc/backup-tools/config.yaml \
  --units-dir /etc/systemd/system \
  --service-config-dir /etc/backup-tools
----

If `--config` is omitted, `/etc/backup-tools/config.yaml` is used.

Run backup manually from generated config:

----
backup.sh /etc/backup-tools/<service>.conf
----

== GENERATED ARTIFACTS

For each valid service entry:

- `backup-<service>.timer` (targets `backup@<escaped-service>.service`)
- `<service-config-dir>/<service>.conf`

If top-level `paths:` is present and non-empty:

- `backup-paths.timer` (targets `backup@paths.service`)
- `<service-config-dir>/paths.conf`

If a service key does not map to an existing `<name>.service` unit on the system,
that entry is skipped and no artifacts are generated for it.

== BACKUP BEHAVIOR

`backup.sh` performs:

1. Load generated config
2. If `SERVICE_NAME` is set, stop target service
3. If `SERVICE_NAME` is set, wait up to `STOP_WAIT_SECONDS` for full stop
4. Create archive with `7z` from `BACKUP_DIRS`
   - `path_mode=target`: store each source under only its target folder name (default behavior)
   - `path_mode=preserve`: keep full source path context (for absolute paths, archive paths like `etc/httpd/...`)
   - `path_mode=contents`: store only each source folder contents (no top folder wrapper)
5. Apply excludes as `-xr!<pattern>` for each entry in `EXCLUDE_PATTERNS`
6. Delete archives older than `BACKUP_RETENTION_DAYS`
7. If `BACKUP_OWNER` is set, apply owner to archive file (`chown`)
8. If `SERVICE_NAME` is set, restart service if it was active and `RESTART_AFTER_BACKUP=true`

Archive naming format:

- `<BACKUP_PREFIX>_<YYYY-MM-DD_HH-MM-SS>.7z`

== EXAMPLE

----
output_dir: /srv/backups
compression_lvl: 3
retention_days: 14
on_calendar: "*-*-* 11:30:00"
randomized_delay: 15m
persistent: true
owner: wyre
path_mode: target

paths:
  - /etc
  - /usr/local/bin
  - /home/wyre/somefolder/id/like/tobackup

services:
  mc@fabric_kmz:
    dirs:
      - /home/wyre/mcserver/Fabric/fabric_kmz
    output_dir: /home/wyre/mcserver/backups
    exclude_patterns:
      - 'dynmap/web/*'

  httpd:
    dirs:
      - /etc/httpd
      - /var/www
    output_dir: /srv/backups/httpd
    exclude_patterns:
      - '*.tmp'
    compression_lvl: 5
    retention_days: 21
    on_calendar: "*-*-* 03:15:00"
    randomized_delay: 5m
    persistent: true
    owner: root
    restart_after_backup: false
    path_mode: target
----

== SEE ALSO

systemd(1), systemd.service(5), systemd.timer(5), 7z(1), yq(1)
